<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Pokročilý váhový tracker více admirála Jiříka</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <style>
body {
  background: #0d1117;
  color: #f0f0f0;
  font-family: Consolas, monospace;
  padding: 20px;
  margin: 0;
  text-align: center;    
}

.container {
  max-width: 1350px; /* Trochu širší kontejner pro více sloupců */
  margin: 0 auto;
}

h1, h2 {
  color: #00d9ff;
  text-align: center;
}

.dashboard {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin: 20px 0;
}

.card {
  background: #1f2633;
  border: 1px solid #444;
  border-radius: 10px;
  padding: 20px;
  transition: transform 0.3s;
}

.card:hover {
  transform: translateY(-5px);
  border-color: #00d9ff;
}

.card h3 {
  color: #00ff99;
  margin-top: 0;
}

.form-group {
  margin: 15px 0;
}

label {
  display: block;
  margin-bottom: 5px;
  color: #00d9ff;
}

input, select, textarea {
  width: 100%;
  padding: 10px;
  background: #0d1117;
  border: 1px solid #444;
  color: #f0f0f0;
  border-radius: 5px;
  box-sizing: border-box;
}

input:focus, select:focus, textarea:focus {
  border-color: #00d9ff;
  outline: none;
}

button {
  background: #00d9ff;
  color: #000;
  padding: 10px 20px;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-weight: bold;
  margin: 5px;
  transition: background 0.3s;
}

button:hover {
  background: #00b8cc;
}

button.danger {
  background: #ff5555;
  color: #fff;
}

button.success {
  background: #55ff99;
  color: #000;
}

button.fullscreen {
  background: #00d9ff;
  color: #000;
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  font-size: 1.2rem;
}

button.fullscreen:hover {
  background: #00b8cc;
  transform: scale(1.1);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #1f2633;
  font-size: 0.9em; /* Menší písmo pro více sloupců */
}

th, td {
  border: 1px solid #444;
  padding: 8px; /* Menší padding */
  text-align: center;
}

th {
  background: #0d1117;
  color: #00d9ff;
}

.gain {
  color: #ff5555;
}

.loss {
  color: #55ff99;
}

.bmi-normal { color: #55ff99; }
.bmi-underweight { color: #00d9ff; }
.bmi-overweight { color: #ffff55; }
.bmi-obese { color: #ff5555; }

.alert {
  padding: 15px;
  margin: 15px 0;
  border-radius: 5px;
  background: #ff5555;
  color: #fff;
  display: none;
}

.alert.show {
  display: block;
}

.stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Ještě menší minmax pro více položek */
  gap: 10px; /* Menší mezery */
  margin: 20px 0;
}

.stat-item {
  background: #1f2633;
  padding: 10px; /* Menší padding */
  border-radius: 10px;
  text-align: center;
  border: 1px solid #444;
}

.stat-value {
  font-size: 1.5em; /* Menší písmo */
  font-weight: bold;
  color: #00d9ff;
}
.stat-label {
    font-size: 0.8em; /* Menší písmo */
    color: #ccc;
    margin-top: 3px;
}


.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #00d9ff;
  color: #000;
  padding: 15px;
  border-radius: 10px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  display: none;
  z-index: 1000;
}

.progress-bar {
  width: 100%;
  height: 20px;
  background: #444;
  border-radius: 10px;
  overflow: hidden;
  margin: 10px 0;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #00d9ff, #00ff99);
  transition: width 0.3s;
}

.tabs {
  display: flex;
  margin: 20px 0;
  border-bottom: 1px solid #444;
}

.tab {
  padding: 10px 20px;
  cursor: pointer;
  border-bottom: 2px solid transparent;
  color: #ccc;
}

.tab.active {
  color: #00d9ff;
  border-bottom-color: #00d9ff;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}
  /* Obecné nastavení kontejneru pro grafy */
.charts-container {
  display: flex;
  flex-wrap: wrap;
  gap: 5px;
  justify-content: center;
  padding: 25px;
  background-color: #2c3e50;
  border-radius: 10px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
}

/* Styl jednotlivých karet s grafem */
.chart-card {
  background-color: white;
  border-radius: 0px;
  padding: 40px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  flex: 1 1 305px;
  max-width: 50px;
  min-width: 280px;
  transition: transform 0.3s ease;
   overflow-x: auto; /* přidá scroll pokud se to nevejde */  
}

.chart-card:hover {
  transform: scale(1.02);
}

/* Nadpis grafu */
.chart-card h3 {
  margin-bottom: 15px;
  font-size: 20px;
  color: #2c3e50;
  text-align: center;
}

/* Canvas grafu */
.chart-card canvas {
  width: 100% !important;
  height: auto !important;
}

      
@media (max-width: 768px) { /* Úprava breakpointu pro lepší zobrazení tabulky */
  .stats {
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  }
   table {
    font-size: 0.75rem; /* Ještě menší písmo pro mobily */
  }
  th, td {
    padding: 4px;
  }
}


@media (max-width: 480px) {
  body {
    padding: 10px;
  }
  h1, h2 {
    font-size: 1.5rem;
  }
  .dashboard {
    grid-template-columns: 1fr;
    gap: 15px;
  }
  .card {
    padding: 15px;
  }
  .charts-container {
    grid-template-columns: 1fr;
  }
  .chart-card {
    padding: 15px;
    overflow-x: auto;
  }
  .stats {
    grid-template-columns: 1fr 1fr; 
  }
  .stat-item {
    padding: 8px;
  }
  .stat-value {
    font-size: 1.2em;
  }
   .stat-label {
    font-size: 0.7em;
  }
  .notification {
    width: 80%;
    left: 10%;
    right: 10%;
  }
  .tabs {
    flex-direction: column;
    border-bottom: none;
  }
  .tab {
    border-bottom: 1px solid #444;
    padding: 8px 15px;
  }
  .tab.active {
    border-left: 3px solid #00d9ff;
    border-bottom: 1px solid #444;
  }
  button {
    padding: 8px 15px;
    width: 100%;
    margin: 5px 0;
  }
  button.fullscreen {
    width: 40px !important;
    height: 40px !important;
    bottom: 10px !important;
    right: 10px !important;
  }
  table {
    font-size: 0.65rem; /* Extrémně malé písmo - zvážit skrytí sloupců */
    display: block; /* Umožní horizontální scroll pro tabulku */
    overflow-x: auto; /* Přidá horizontální scroll pro tabulku */
  }
  th, td {
    padding: 3px;
     white-space: nowrap; /* Zabrání zalomení textu v buňkách */
  }
}

.charts-container {
  display: grid; 
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
  gap: 20px; 
  padding: 20px; 
  background-color: #1a222d; 
  border-radius: 10px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
  margin-top: 20px; 
}

.chart-card {
  background-color: #1f2633; 
  border-radius: 10px; 
  padding: 20px; 
  box-shadow: none; 
  border: 1px solid #444; 
  transition: transform 0.3s ease, border-color 0.3s ease; 
  overflow-x: auto;
}
.chart-card:hover {
  transform: translateY(-5px); 
  border-color: #00d9ff; 
}

.chart-card h3 {
  margin-bottom: 15px;
  font-size: 1.2rem; 
  color: #00ff99; 
  text-align: center;
}

.chart-card canvas {
  width: 100% !important;
  height: auto !important;
  max-height: 200px; 
}

@media (max-width: 600px) {
  .charts-container {
    grid-template-columns: 1fr; 
    padding: 10px;
  }
   .chart-card {
    padding: 15px;
  }
}
  </style>
</head>
<body>
  <div class="container">
    <h1>🖖 Pokročilý váhový tracker více admirála Jiříka</h1>
    
    <div class="notification" id="notification"></div>
    <div class="alert" id="bmiAlert"></div>
    
    <div class="tabs">
      <div class="tab active" onclick="showTab('dashboard')">Dashboard</div>
      <div class="tab" onclick="showTab('add-entry')">Nový záznam</div>
      <div class="tab" onclick="showTab('goals')">Cíle</div>
      <div class="tab" onclick="showTab('settings')">Nastavení</div>
      <div class="tab" onclick="showTab('export')">Export/Import</div>
    </div>

    <div id="dashboard" class="tab-content active">
      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="currentWeight">-</div>
          <div class="stat-label">Aktuální váha (kg)</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="currentBMI">-</div>
          <div class="stat-label">Aktuální BMI</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="weightChange">-</div>
          <div class="stat-label">Změna váhy (kg)</div>
        </div>
         <div class="stat-item">
          <div class="stat-value" id="currentBodyWater">-</div>
          <div class="stat-label">Voda v těle (%)</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="lastManualBMR">-</div>
          <div class="stat-label">Posl. zadaný BMR</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="lastManualAMR">-</div>
          <div class="stat-label">Posl. zadaný AMR</div>
        </div>
         <div class="stat-item">
          <div class="stat-value" id="theoreticalBMR">-</div>
          <div class="stat-label">Teoretický BMR</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="theoreticalAMR">-</div>
          <div class="stat-label">Teoretický AMR</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="goalProgress">-</div>
          <div class="stat-label">Pokrok k cíli (%)</div>
        </div>
      </div>

      <div id="goalProgressBarCard" class="card" style="display:none; margin-bottom: 20px;">
        <h3>Pokrok k cíli</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progressFill"></div>
        </div>
        <div id="goalStatus" style="text-align: center; margin-top: 10px; color: #00d9ff;"></div>
        <div id="goalEstimate" class="stat-subtext" style="text-align: center; margin-top: 5px; color: #ccc;">Odhad: ...</div>
        <div id="latestEntryDate" style="text-align: center; margin-top: 5px; font-size: 0.9em; color: #aaa;"></div>
      </div>

      <div class="charts-container">
        <div class="chart-card">
          <h3>Vývoj váhy</h3>
          <canvas id="weightChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Vývoj BMI</h3>
          <canvas id="bmiChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Vývoj tělesného tuku (%)</h3>
          <canvas id="bodyFatOnlyChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Vývoj svalové hmoty (%)</h3> <canvas id="muscleMassOnlyChart"></canvas>
        </div>
         <div class="chart-card">
          <h3>Vývoj vody v těle</h3>
          <canvas id="bodyWaterChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Vývoj zadaného BMR (kcal)</h3>
          <canvas id="manualBMRChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Vývoj zadaného AMR (kcal)</h3>
          <canvas id="manualAMRChart"></canvas>
        </div>
      </div>

      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Datum</th>
            <th>Váha</th>
            <th>Rozdíl</th>
            <th>BMI</th>
            <th>Klasif.</th>
            <th>Tuk%</th>
            <th>Svaly (%)</th> <th>Voda%</th>
            <th>Zad. BMR</th>
            <th>Zad. AMR</th>
            <th>Pozn.</th>
            <th>Akce</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div id="add-entry" class="tab-content">
      <div class="card">
        <h3>Přidat nový záznam</h3>
        <form id="entryForm">
          <div class="form-group">
            <label for="entryDate">Datum:</label>
            <input type="date" id="entryDate" required>
          </div>
          <div class="form-group">
            <label for="entryWeight">Váha (kg):</label>
            <input type="number" id="entryWeight" step="0.1" required>
          </div>
          <div class="form-group">
            <label for="entryBodyFat">Tělesný tuk (%):</label>
            <input type="number" id="entryBodyFat" step="0.1" min="0" max="100">
          </div>
          <div class="form-group">
            <label for="entryMuscleMass">Svalová hmota (kg):</label>
            <input type="number" id="entryMuscleMass" step="0.1" min="0">
          </div>
          <div class="form-group">
            <label for="entryBodyWater">Voda v těle (%):</label>
            <input type="number" id="entryBodyWater" step="0.1" min="0" max="100">
          </div>
          <div class="form-group">
            <label for="entryManualBMR">Ručně zadané BMR (kcal):</label>
            <input type="number" id="entryManualBMR" step="1" min="0">
          </div>
          <div class="form-group">
            <label for="entryManualAMR">Ručně zadané AMR (kcal):</label>
            <input type="number" id="entryManualAMR" step="1" min="0">
          </div>
          <div class="form-group">
            <label for="entryNotes">Poznámky:</label>
            <textarea id="entryNotes" rows="3"></textarea>
          </div>
          <button type="submit">Přidat záznam</button>
        </form>
      </div>
    </div>

    <div id="goals" class="tab-content">
      <div class="card">
        <h3>Nastavení cílů</h3>
        <form id="goalsForm">
          <div class="form-group">
            <label for="targetWeight">Cílová váha (kg):</label>
            <input type="number" id="targetWeight" step="0.1">
          </div>
          <div class="form-group">
            <label for="targetBMI">Cílové BMI:</label>
            <input type="number" id="targetBMI" step="0.1">
          </div>
          <div class="form-group">
            <label for="targetDate">Termín splnění cíle:</label>
            <input type="date" id="targetDate">
          </div>
          <div class="form-group">
            <label for="weeklyGoal">Týdenní změna váhy (kg) (např. -0.5 pro hubnutí):</label>
            <input type="number" id="weeklyGoal" step="0.1">
          </div>
          <button type="submit">Uložit cíle</button>
        </form>
        
        <div id="recommendations" class="card" style="margin-top: 20px; background: #2a3441;">
          <h3>Doporučení</h3>
          <div id="recommendationText"></div>
        </div>
      </div>
    </div>

    <div id="settings" class="tab-content">
      <div class="dashboard">
        <div class="card">
          <h3>Osobní údaje (pro teoretické výpočty)</h3>
          <form id="settingsForm">
            <div class="form-group">
              <label for="height">Výška (cm):</label>
              <input type="number" id="height" min="100" max="250" value="174">
            </div>
            <div class="form-group">
              <label for="age">Věk:</label>
              <input type="number" id="age" min="1" max="120">
            </div>
            <div class="form-group">
              <label for="gender">Pohlaví:</label>
              <select id="gender">
                <option value="male">Muž</option>
                <option value="female">Žena</option>
              </select>
            </div>
            <div class="form-group">
              <label for="activityLevel">Úroveň fyzické aktivity:</label>
              <select id="activityLevel">
                <option value="1.2">Sedavé (málo nebo žádné cvičení)</option>
                <option value="1.375">Lehce aktivní (cvičení 1-3 dny/týden)</option>
                <option value="1.55">Mírně aktivní (cvičení 3-5 dní/týden)</option>
                <option value="1.725">Velmi aktivní (cvičení 6-7 dní/týden)</option>
                <option value="1.9">Extrémně aktivní (velmi těžké cvičení, fyzická práce)</option>
              </select>
            </div>
            <button type="submit">Uložit nastavení</button>
          </form>
        </div>

        <div class="card">
          <h3>BMI hranice</h3>
          <form id="bmiAlertsForm">
            <div class="form-group">
              <label for="bmiWarningUpper">Horní hranice BMI (varování):</label>
              <input type="number" id="bmiWarningUpper" step="0.1" value="25">
            </div>
            <div class="form-group">
              <label for="bmiDangerUpper">Horní hranice BMI (nebezpečí):</label>
              <input type="number" id="bmiDangerUpper" step="0.1" value="30">
            </div>
            <div class="form-group">
              <label for="bmiWarningLower">Dolní hranice BMI (varování):</label>
              <input type="number" id="bmiWarningLower" step="0.1" value="18.5">
            </div>
            <button type="submit">Uložit hranice</button>
          </form>
        </div>

        <div class="card">
          <h3>Připomínky</h3>
          <form id="remindersForm">
            <div class="form-group">
              <label for="reminderEnabled">Povolit připomínky:</label>
              <input type="checkbox" id="reminderEnabled" style="width: auto;">
            </div>
            <div class="form-group">
              <label for="reminderInterval">Interval připomínek (dny):</label>
              <input type="number" id="reminderInterval" min="1" max="30" value="7">
            </div>
            <button type="submit">Uložit připomínky</button>
          </form>
        </div>
      </div>
    </div>

    <div id="export" class="tab-content">
      <div class="dashboard">
        <div class="card">
          <h3>Export dat</h3>
          <button onclick="exportToCSV()">📊 Export do CSV</button>
          <button onclick="exportToPDF()">📄 Export do PDF</button>
          <button onclick="exportChartsAsPDF()">📈 Export grafů do PDF</button>
          <button onclick="exportBackup()">💾 Úplná záloha</button>
        </div>

        <div class="card">
          <h3>Import dat</h3>
          <div class="form-group">
            <label for="csvImport">Import CSV:</label>
            <input type="file" id="csvImport" accept=".csv" onchange="importFromCSV(this)">
          </div>
          <div class="form-group">
            <label for="backupImport">Obnovit ze zálohy:</label>
            <input type="file" id="backupImport" accept=".json" onchange="importFromBackup(this)">
          </div>
          <button class="danger" onclick="clearAllData()">🗑️ Vymazat všechna data</button>
        </div>
      </div>
    </div>
  </div>

   
    <script>
    // Globální proměnné
    let weightChart, bmiChart, bodyFatOnlyChart, muscleMassOnlyChart, bodyWaterChart, manualBMRChart, manualAMRChart;
    let weightLog = [];
    let settings = {
      height: 174,
      age: 24, 
      gender: 'male',
      activityLevel: 1.55, 
      bmiWarningUpper: 25,
      bmiDangerUpper: 30,
      bmiWarningLower: 18.5,
      reminderEnabled: true,
      reminderInterval: 7
    };
    let goals = {
      targetWeight: 80,
      targetBMI: 24.9,
      targetDate: '2026-05-18',
      weeklyGoal: null
    };

    const ACTIVITY_LEVELS = {
        SEDENTARY: 1.2,
        LIGHT: 1.375,
        MODERATE: 1.55,
        ACTIVE: 1.725,
        VERY_ACTIVE: 1.9
    };

    document.addEventListener('DOMContentLoaded', function() {
      loadData();
      initializeCharts();
      updateDisplay();
      checkReminders();
      setTodayDate();
    });

    function setTodayDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('entryDate').value = today;
    }

    function loadData() {
      const savedWeightLog = localStorage.getItem('weightLog_JirikTracker_v2_charts_separated_musclePercent');
      const savedSettings = localStorage.getItem('weightSettings_JirikTracker_v2_charts_separated_musclePercent');
      const savedGoals = localStorage.getItem('weightGoals_JirikTracker_v2_charts_separated_musclePercent');

      if (savedWeightLog) {
        weightLog = JSON.parse(savedWeightLog);
      } else {
        // Příklad dat, aby bylo co zobrazit při prvním spuštění
        weightLog = [
             //moje váhá!!!
{ date: "2024-05-25", weight: 133.6, bodyFat: 41.5, muscleMass: 31.0, bodyWater: 40.2, manualBMR: 2665 , manualAMR:3205, notes: "Start" },
{ date: "2024-05-26", weight: 134.0, bodyFat: 41.8, muscleMass: 30.9, bodyWater: 40.0, manualBMR: 2676, manualAMR: 3211, notes: "" },
{ date: "2024-06-01", weight: 134.0, bodyFat: 41.8, muscleMass: 30.9, bodyWater: 40.0, manualBMR: 2671, manualAMR: 3205, notes: "" },
{ date: "2024-06-01", weight: 133.4, bodyFat: 42.0, muscleMass: 30.7, bodyWater: 39.8, manualBMR: 2670, manualAMR: 3194, notes: "" },
{ date: "2024-06-07", weight: 132.2, bodyFat: 41.1, muscleMass: 31.2, bodyWater: 40.4, manualBMR: 2645, manualAMR: 3174, notes: "" },
{ date: "2024-06-08", weight: 131.3, bodyFat: 40.9, muscleMass: 31.3, bodyWater: 40.6, manualBMR: 2632, manualAMR: 3158, notes: "" },
{ date: "2024-06-08", weight: 131.3, bodyFat: 40.7, muscleMass: 31.4, bodyWater: 40.7, manualBMR: 2632, manualAMR: 3158, notes: "" },
{ date: "2024-06-09", weight: 132.2, bodyFat: 42.8, muscleMass: 30.3, bodyWater: 39.3, manualBMR: 2645, manualAMR: 3174, notes: "" },
{ date: "2024-06-11", weight: 131.5, bodyFat: 41.0, muscleMass: 31.2, bodyWater: 40.5, manualBMR: 2635, manualAMR: 3162, notes: "" },
{ date: "2024-06-18", weight: 134.6, bodyFat: 42.2, muscleMass: 30.6, bodyWater: 39.7, manualBMR: 2678, manualAMR: 3213, notes: "" },
{ date: "2024-06-20", weight: 134.4, bodyFat: 42.1, muscleMass: 30.7, bodyWater: 39.8, manualBMR: 2676, manualAMR: 3211, notes: "" },
{ date: "2024-06-20", weight: 134.4, bodyFat: 42.0, muscleMass: 30.7, bodyWater: 39.8, manualBMR: 2676, manualAMR: 3211, notes: "" },
{ date: "2024-06-21", weight: 136.7, bodyFat: 43.0, muscleMass: 30.2, bodyWater: 39.1, manualBMR: 2708, manualAMR: 3249, notes: "" },
{ date: "2024-06-29", weight: 137.3, bodyFat: 43.4, muscleMass: 30.0, bodyWater: 38.9, manualBMR: 2716, manualAMR: 3259, notes: "" },
{ date: "2024-07-03", weight: 136.9, bodyFat: 43.0, muscleMass: 30.2, bodyWater: 39.1, manualBMR: 2711, manualAMR: 3253, notes: "" },
{ date: "2024-07-09", weight: 139.3, bodyFat: 44.0, muscleMass: 29.7, bodyWater: 38.5, manualBMR: 2744, manualAMR: 3292, notes: "" },
{ date: "2024-09-08", weight: 138.6, bodyFat: 43.7, muscleMass: 29.9, bodyWater: 38.7, manualBMR: 2734, manualAMR: 3280, notes: "" },
{ date: "2025-02-16", weight: 145.6, bodyFat: 46.5, muscleMass: 28.3, bodyWater: 36.7, manualBMR: 2831, manualAMR: 3397, notes: "" },
{ date: "2025-04-19", weight: 146.3, bodyFat: 47.0, muscleMass: 28.1, bodyWater: 36.4, manualBMR: 2842, manualAMR: 3410, notes: "" },
{ date: "2025-05-10", weight: 144.2, bodyFat: 45.8, muscleMass: 28.7, bodyWater: 37.2, manualBMR: 2806, manualAMR: 3367, notes: "" },
{ date: "2025-05-13", weight: 141.3, bodyFat: 44.6, muscleMass: 29.3, bodyWater: 38.0, manualBMR: 2765, manualAMR: 3318, notes: "" },
{ date: "2025-05-18", weight: 138.8, bodyFat: 43.7, muscleMass: 29.3, bodyWater: 38.7, manualBMR: 2731, manualAMR: 3277, notes: "" },
{ date: "2025-05-19", weight: 139.3, bodyFat: 45.8, muscleMass: 28.7, bodyWater: 37.2, manualBMR: 2728, manualAMR: 3273, notes: "" },
{ date: "2025-05-20", weight: 138.5, bodyFat: 45.5, muscleMass: 28.9, bodyWater: 37.4, manualBMR: 2716, manualAMR: 3259, notes: "" },  
{ date: "2025-05-21", weight: 138.3, bodyFat: 45.4, muscleMass: 29.0, bodyWater: 37.5, manualBMR: 2713, manualAMR: 3255, notes: "Pokles" },  
{ date: "2025-05-22", weight: 139.2, bodyFat: 45.7, muscleMass: 28.8, bodyWater: 37.3, manualBMR: 2725, manualAMR: 3270, notes: "Nárust" }, 
{ date: "2025-05-23", weight: 139.2, bodyFat: 45.9, muscleMass: 28.7, bodyWater: 37.1, manualBMR: 2725, manualAMR: 3270, notes: "Stabylní" },  
{ date: "2025-05-24", weight: 139.7, bodyFat: 46.0, muscleMass: 28.7, bodyWater: 37.1, manualBMR: 2733, manualAMR: 3270, notes: "Nárust" },         { date: "2025-05-25", weight: 140.3, bodyFat: 46.2, muscleMass: 28.5, bodyWater: 36.9, manualBMR: 2741, manualAMR: 3279, notes: "Nárust" },    
{ date: "2025-05-31", weight: 140.0, bodyFat: 46.2, muscleMass: 28.7, bodyWater: 37.1, manualBMR: 2737, manualAMR: 3289, notes: "" },        
{ date: "2025-06-01", weight: 140.0, bodyFat: 46.2, muscleMass: 28.5, bodyWater: 36.9, manualBMR: 2737, manualAMR: 3289, notes: "" },            
        ];
      }

      if (savedSettings) {
        settings = { ...settings, ...JSON.parse(savedSettings) };
      }
       if (savedGoals) {
        goals = { ...goals, ...JSON.parse(savedGoals) };
      }
      settings.activityLevel = parseFloat(settings.activityLevel) || 1.55;

      updateForms();
      // Uloží výchozí data jen pokud nic nebylo načteno a weightLog byl naplněn výchozími daty
      if (weightLog.length > 0 && !savedWeightLog) { 
          saveData();
      }
    }

    function saveData() {
      localStorage.setItem('weightLog_JirikTracker_v2_charts_separated_musclePercent', JSON.stringify(weightLog));
      localStorage.setItem('weightSettings_JirikTracker_v2_charts_separated_musclePercent', JSON.stringify(settings));
      localStorage.setItem('weightGoals_JirikTracker_v2_charts_separated_musclePercent', JSON.stringify(goals));
    }

    function updateForms() {
      document.getElementById('height').value = settings.height || '';
      document.getElementById('age').value = settings.age || '';
      document.getElementById('gender').value = settings.gender || 'male';
      document.getElementById('activityLevel').value = settings.activityLevel || '1.55';
      document.getElementById('bmiWarningUpper').value = settings.bmiWarningUpper || '';
      document.getElementById('bmiDangerUpper').value = settings.bmiDangerUpper || '';
      document.getElementById('bmiWarningLower').value = settings.bmiWarningLower || '';
      document.getElementById('reminderEnabled').checked = settings.reminderEnabled === true;
      document.getElementById('reminderInterval').value = settings.reminderInterval || 7;

      document.getElementById('targetWeight').value = goals.targetWeight || '';
      document.getElementById('targetBMI').value = goals.targetBMI || '';
      document.getElementById('targetDate').value = goals.targetDate || '';
      document.getElementById('weeklyGoal').value = goals.weeklyGoal || '';
    }

    function calculateBMI(weight, height) {
      if (!height || height <=0 || !weight || weight <=0) return 0;
      const heightInMeters = height / 100;
      return weight / (heightInMeters * heightInMeters);
    }

    function calculateBMR(weight, height, age, gender) {
        if (!weight || !height || !age || !gender) return 0;
        if (gender === 'male') {
            return (10 * weight) + (6.25 * height) - (5 * age) + 5;
        } else { 
            return (10 * weight) + (6.25 * height) - (5 * age) - 161;
        }
    }

    function calculateAMR(bmr, activityLevel) {
        if (!bmr || !activityLevel) return 0;
        return bmr * activityLevel;
    }

    function classifyBMI(bmi) {
      if (bmi === 0) return { class: '', text: '-' };
      if (bmi < 18.5) return { class: 'bmi-underweight', text: 'Podváha' };
      if (bmi < 25) return { class: 'bmi-normal', text: 'Normální' };
      if (bmi < 30) return { class: 'bmi-overweight', text: 'Nadváha' };
      return { class: 'bmi-obese', text: 'Obezita' };
    }

    function checkBMIAlert(bmi) {
      const alertEl = document.getElementById('bmiAlert');
      if (bmi === 0) {
          alertEl.className = 'alert';
          return;
      }
      if (bmi > settings.bmiDangerUpper) {
        alertEl.innerHTML = `⚠️ Varování: Vaše BMI (${bmi.toFixed(1)}) je výrazně nad doporučenou hranicí!`;
        alertEl.className = 'alert show';
        alertEl.style.background = '#ff5555';
      } else if (bmi > settings.bmiWarningUpper) {
        alertEl.innerHTML = `⚡ Upozornění: Vaše BMI (${bmi.toFixed(1)}) překračuje doporučenou hranici.`;
        alertEl.className = 'alert show';
        alertEl.style.background = '#ffaa00';
      } else if (bmi < settings.bmiWarningLower && bmi > 0) { 
        alertEl.innerHTML = `⚡ Upozornění: Vaše BMI (${bmi.toFixed(1)}) je pod doporučenou hranicí.`;
        alertEl.className = 'alert show';
        alertEl.style.background = '#00aaff';
      } else {
        alertEl.className = 'alert';
      }
    }

    function showNotification(message, duration = 3000) {
      const notification = document.getElementById('notification');
      notification.textContent = message;
      notification.style.display = 'block';
      setTimeout(() => {
        notification.style.display = 'none';
      }, duration);
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.querySelector(`[onclick="showTab('${tabName}')"]`).classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }
    
    function formatDateForDisplay(dateStr) {
        if (!dateStr) return '-';
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return 'Neplatné datum';
        const day = date.getDate();
        const month = date.getMonth() + 1; 
        const year = date.getFullYear();
        return `${day}. ${month}. ${year}`;
    }

    function initializeCharts() {
      const commonOptions = (yLabel, xLabelColor = '#00d9ff', yLabelColor = '#00d9ff', gridColor = '#444', yPrecision = 1) => ({
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: false,
            grid: { color: gridColor },
            ticks: { color: yLabelColor, precision: yPrecision }, 
            title: { display: !!yLabel, text: yLabel, color: yLabelColor }
          },
          x: {
            grid: { color: gridColor },
            ticks: { color: xLabelColor, autoSkip: true, maxTicksLimit: 10 }
          }
        },
        plugins: {
          legend: { labels: { color: xLabelColor } }
        }
      });
      
      const lineChartDataset = (label, data, borderColor, bgColor) => ({
          label: label,
          data: data,
          borderColor: borderColor,
          backgroundColor: bgColor,
          tension: 0.1,
          pointBackgroundColor: borderColor,
          pointBorderColor: '#fff',
          pointRadius: 4,
          pointHoverRadius: 6
      });

      weightChart = new Chart(document.getElementById('weightChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [lineChartDataset('Váha (kg)', [], '#00d9ff', 'rgba(0,217,255,0.2)')] },
        options: commonOptions('Váha (kg)')
      });

      bmiChart = new Chart(document.getElementById('bmiChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [lineChartDataset('BMI', [], '#55ff99', 'rgba(85,255,153,0.2)')] },
        options: commonOptions('BMI')
      });

      bodyWaterChart = new Chart(document.getElementById('bodyWaterChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [lineChartDataset('Voda v těle (%)', [], '#00aaff', 'rgba(0,170,255,0.2)')] },
        options: commonOptions('Voda v těle (%)')
      });
      
      manualBMRChart = new Chart(document.getElementById('manualBMRChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [lineChartDataset('Zadané BMR (kcal)', [], '#ff9933', 'rgba(255,153,51,0.2)')] }, 
        options: commonOptions('BMR (kcal)', undefined, undefined, undefined, 0)
      });

      manualAMRChart = new Chart(document.getElementById('manualAMRChart').getContext('2d'), {
        type: 'line',
        data: { labels: [], datasets: [lineChartDataset('Zadané AMR (kcal)', [], '#cc66ff', 'rgba(204,102,255,0.2)')] }, 
        options: commonOptions('AMR (kcal)', undefined, undefined, undefined, 0)
      });
      
      bodyFatOnlyChart = new Chart(document.getElementById('bodyFatOnlyChart').getContext('2d'), {
          type: 'line',
          data: { labels: [], datasets: [lineChartDataset('Tělesný tuk (%)', [], '#ff5555', 'rgba(255,85,85,0.2)')]},
          options: commonOptions('Tuk (%)')
      });

      muscleMassOnlyChart = new Chart(document.getElementById('muscleMassOnlyChart').getContext('2d'), {
          type: 'line',
          data: { labels: [], datasets: [lineChartDataset('Svalová hmota (%)', [], '#ffff55', 'rgba(255,255,85,0.2)')]},
          options: commonOptions('Svaly (%)')
      });
    }

    function updateCharts() {
      if (!weightLog || weightLog.length === 0) return;
      const sortedData = [...weightLog].sort((a, b) => new Date(a.date) - new Date(b.date));
      const labels = sortedData.map(entry => formatDateForDisplay(entry.date));
      
      const weights = sortedData.map(entry => entry.weight);
      const bmis = sortedData.map(entry => calculateBMI(entry.weight, settings.height).toFixed(1));
      const bodyFats = sortedData.map(entry => entry.bodyFat);
      
      const muscleMassPercentages = sortedData.map(entry => {
          if (entry.muscleMass && entry.weight && entry.weight > 0) {
              return parseFloat(((entry.muscleMass / entry.weight) * 100).toFixed(1));
          }
          return NaN;
      });

      const bodyWaters = sortedData.map(entry => entry.bodyWater);
      const manualBMRs = sortedData.map(entry => entry.manualBMR); 
      const manualAMRs = sortedData.map(entry => entry.manualAMR); 


      weightChart.data.labels = labels;
      weightChart.data.datasets[0].data = weights;
      weightChart.update();

      bmiChart.data.labels = labels;
      bmiChart.data.datasets[0].data = bmis;
      bmiChart.update();

      bodyWaterChart.data.labels = labels;
      bodyWaterChart.data.datasets[0].data = bodyWaters.map(bw => bw === null || bw === undefined ? NaN : bw); 
      bodyWaterChart.update();
      
      manualBMRChart.data.labels = labels;
      manualBMRChart.data.datasets[0].data = manualBMRs.map(val => val === null || val === undefined ? NaN : val);
      manualBMRChart.update();

      manualAMRChart.data.labels = labels;
      manualAMRChart.data.datasets[0].data = manualAMRs.map(val => val === null || val === undefined ? NaN : val);
      manualAMRChart.update();
      
      bodyFatOnlyChart.data.labels = labels;
      bodyFatOnlyChart.data.datasets[0].data = bodyFats.map(bf => bf === null || bf === undefined ? NaN : bf);
      bodyFatOnlyChart.update();

      muscleMassOnlyChart.data.labels = labels;
      muscleMassOnlyChart.data.datasets[0].data = muscleMassPercentages;
      muscleMassOnlyChart.update();
    }

    function updateTable() {
      const tableBody = document.getElementById('tableBody');
      tableBody.innerHTML = '';
      if (!weightLog || settings.height <=0) return;

      const sortedData = [...weightLog].sort((a, b) => new Date(b.date) - new Date(a.date)); 
      
      sortedData.forEach((entry, index) => {
        const bmi = calculateBMI(entry.weight, settings.height);
        const classification = classifyBMI(bmi);
        
        let weightDiffText = '-';
        let diffClass = '';
        const chronologicalIndex = weightLog.slice().sort((a, b) => new Date(a.date) - new Date(b.date)).findIndex(e => e.date === entry.date);
        const previousChronologicalEntry = chronologicalIndex > 0 ? weightLog.slice().sort((a,b) => new Date(a.date) - new Date(b.date))[chronologicalIndex -1] : null;

        if (previousChronologicalEntry) {
            const weightDiff = (entry.weight - previousChronologicalEntry.weight);
            weightDiffText = (weightDiff > 0 ? '+' : '') + weightDiff.toFixed(1);
            diffClass = weightDiff > 0 ? 'gain' : (weightDiff < 0 ? 'loss' : '');
        }

        let muscleMassDisplay = '-';
        if (entry.muscleMass && entry.weight && entry.weight > 0) {
            muscleMassDisplay = ((entry.muscleMass / entry.weight) * 100).toFixed(1) + '%';
        }
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${sortedData.length - index}</td>
          <td>${formatDateForDisplay(entry.date)}</td>
          <td>${entry.weight !== null && entry.weight !== undefined ? entry.weight.toFixed(1) : '-'}</td>
          <td class="${diffClass}">${weightDiffText}</td>
          <td class="${classification.class}">${bmi > 0 ? bmi.toFixed(1) : '-'}</td>
          <td class="${classification.class}">${classification.text}</td>
          <td>${entry.bodyFat !== null && entry.bodyFat !== undefined ? entry.bodyFat.toFixed(1) : '-'}%</td>
          <td>${muscleMassDisplay}</td>
          <td>${entry.bodyWater !== null && entry.bodyWater !== undefined ? entry.bodyWater.toFixed(1) : '-'}%</td>
          <td>${entry.manualBMR !== null && entry.manualBMR !== undefined ? entry.manualBMR : '-'}</td>
          <td>${entry.manualAMR !== null && entry.manualAMR !== undefined ? entry.manualAMR : '-'}</td>
          <td title="${entry.notes || ''}">${(entry.notes || '').substring(0,10)}${(entry.notes || '').length > 10 ? '...' : ''}</td>
          <td>
            <button class="danger" onclick="deleteEntry('${entry.date}')" title="Smazat">🗑️</button>
            <button onclick="editEntry('${entry.date}')" title="Upravit">✏️</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }
    
    function updateStats() {
        if (weightLog.length === 0) {
            document.getElementById('currentWeight').textContent = '-';
            document.getElementById('currentBMI').textContent = '-';
            document.getElementById('currentBMI').className = 'stat-value';
            document.getElementById('weightChange').textContent = '-';
            document.getElementById('weightChange').className = 'stat-value';
            document.getElementById('currentBodyWater').textContent = '-';
            document.getElementById('lastManualBMR').textContent = '-';
            document.getElementById('lastManualAMR').textContent = '-';
            document.getElementById('theoreticalBMR').textContent = '-';
            document.getElementById('theoreticalAMR').textContent = '-';
            document.getElementById('goalProgress').textContent = '-';
            document.getElementById('goalProgressBarCard').style.display = 'none';
            document.getElementById('latestEntryDate').textContent = 'Žádná data k zobrazení.';
            return;
        }

        const sortedLog = [...weightLog].sort((a, b) => new Date(a.date) - new Date(b.date)); 
        const latestEntry = sortedLog[sortedLog.length - 1];
        
        const currentWeight = latestEntry.weight;
        const currentBMI = calculateBMI(currentWeight, settings.height);
        const currentBodyWater = latestEntry.bodyWater;

        document.getElementById('currentWeight').textContent = currentWeight.toFixed(1);
        document.getElementById('currentBMI').textContent = currentBMI > 0 ? currentBMI.toFixed(1) : '-';
        document.getElementById('currentBMI').className = 'stat-value ' + classifyBMI(currentBMI).class;
        document.getElementById('currentBodyWater').textContent = currentBodyWater !== null && currentBodyWater !== undefined ? currentBodyWater.toFixed(1) : '-';
        document.getElementById('lastManualBMR').textContent = latestEntry.manualBMR !== null && latestEntry.manualBMR !== undefined ? latestEntry.manualBMR : '-';
        document.getElementById('lastManualAMR').textContent = latestEntry.manualAMR !== null && latestEntry.manualAMR !== undefined ? latestEntry.manualAMR : '-';

        let weightChangeVal = 0;
        let weightChangeText = '-';
        let changeClass = '';
        if (sortedLog.length >= 2) {
            const previousEntry = sortedLog[sortedLog.length - 2];
            weightChangeVal = currentWeight - previousEntry.weight;
            weightChangeText = (weightChangeVal >= 0 ? '+' : '') + weightChangeVal.toFixed(1);
            changeClass = weightChangeVal > 0 ? 'gain' : (weightChangeVal < 0 ? 'loss' : '');
        }
        document.getElementById('weightChange').textContent = weightChangeText;
        document.getElementById('weightChange').className = 'stat-value ' + changeClass;

        const theoBMR = calculateBMR(currentWeight, settings.height, settings.age, settings.gender);
        const theoAMR = calculateAMR(theoBMR, settings.activityLevel);
        document.getElementById('theoreticalBMR').textContent = theoBMR > 0 ? Math.round(theoBMR) : '-';
        document.getElementById('theoreticalAMR').textContent = theoAMR > 0 ? Math.round(theoAMR) : '-';
        
        document.getElementById('latestEntryDate').textContent = `Poslední záznam: ${formatDateForDisplay(latestEntry.date)}`;

        if (goals.targetWeight && sortedLog.length > 0) {
            const initialWeight = sortedLog[0].weight; 
            const totalChangeNeeded = goals.targetWeight - initialWeight;
            const currentChangeAchieved = currentWeight - initialWeight;
            let progressPercent = 0;

            if (totalChangeNeeded !== 0) {
                if ((totalChangeNeeded < 0 && currentWeight <= initialWeight && currentWeight >= goals.targetWeight) || 
                    (totalChangeNeeded > 0 && currentWeight >= initialWeight && currentWeight <= goals.targetWeight)) {
                    progressPercent = (Math.abs(currentChangeAchieved) / Math.abs(totalChangeNeeded)) * 100;
                } else if ((totalChangeNeeded < 0 && currentWeight < goals.targetWeight) || (totalChangeNeeded > 0 && currentWeight > goals.targetWeight)) {
                    progressPercent = 100;
                } else {
                    progressPercent = 0;
                }
            } else { 
                progressPercent = (initialWeight === currentWeight) ? 100 : 0;
            }
            progressPercent = Math.min(100, Math.max(0, progressPercent)); 

            document.getElementById('goalProgress').textContent = `${progressPercent.toFixed(1)}%`;
            document.getElementById('goalProgressBarCard').style.display = 'block';
            document.getElementById('progressFill').style.width = `${progressPercent}%`;
            
            const remainingKg = goals.targetWeight - currentWeight;
            if (progressPercent >= 100) {
                 document.getElementById('goalStatus').textContent = `🎉 Cíl ${goals.targetWeight} kg dosažen/překonán!`;
            } else {
                 document.getElementById('goalStatus').textContent = `Zbývá: ${remainingKg.toFixed(1)} kg do cíle (${goals.targetWeight} kg)`;
            }

            const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;
            const now = new Date();
            const recentLog = sortedLog.filter(entry => (now - new Date(entry.date)) <= THIRTY_DAYS_MS);

            if (recentLog.length >= 2 && remainingKg !== 0) {
                const oldestRecent = recentLog[0];
                const latestRecent = recentLog[recentLog.length - 1];
                const daysElapsed = Math.max(1, Math.floor((new Date(latestRecent.date) - new Date(oldestRecent.date)) / (1000 * 60 * 60 * 24)));
                const weightChangeInPeriod = latestRecent.weight - oldestRecent.weight;
                const dailyChange = weightChangeInPeriod / daysElapsed;
                let estimateText = 'Nedostatek dat pro odhad.';

                if (dailyChange !== 0 && ((remainingKg < 0 && dailyChange < 0) || (remainingKg > 0 && dailyChange > 0))) { 
                    const estimatedDays = Math.abs(remainingKg / dailyChange);
                     if (estimatedDays > 365 * 3) { 
                        estimateText = 'Odhad: více než 3 roky';
                    } else if (estimatedDays > 365) { 
                        estimateText = `Odhad: cca ${Math.round(estimatedDays/30.44)} měsíců`;
                    } else {
                        estimateText = `Odhad: cca ${Math.round(estimatedDays)} dní (~${Math.round(estimatedDays / 7)} týdnů)`;
                    }
                } else if (dailyChange === 0 && remainingKg !== 0) {
                    estimateText = 'Odhad: stagnace, cíl se nepřibližuje.';
                } else if (remainingKg !== 0) { 
                     estimateText = 'Odhad: aktuálně se vzdalujete od cíle.';
                }
                 document.getElementById('goalEstimate').textContent = estimateText;
            } else if (remainingKg === 0) {
                document.getElementById('goalEstimate').textContent = 'Cíl dosažen!';
            } else {
                document.getElementById('goalEstimate').textContent = 'Nedostatek dat za posl. 30 dní pro odhad.';
            }
        } else {
            document.getElementById('goalProgress').textContent = '-';
            document.getElementById('goalProgressBarCard').style.display = 'none';
            document.getElementById('goalEstimate').textContent = 'Cíl není nastaven.';
        }
         checkBMIAlert(currentBMI);
    }

    function updateRecommendations() {
      if (weightLog.length === 0 ) { 
          document.getElementById('recommendationText').innerHTML = '<p>Pro doporučení zadejte více dat.</p>';
          return;
      }
      const sortedDataDesc = [...weightLog].sort((a, b) => new Date(b.date) - new Date(a.date)); 
      const latestEntry = sortedDataDesc[0];
      const currentWeight = latestEntry.weight;
      const currentBMI = calculateBMI(currentWeight, settings.height);
      
      let recommendations = [];

      if (currentBMI > 0) {
          if (currentBMI < 18.5) recommendations.push("💚 Vaše BMI naznačuje podváhu. Zvažte konzultaci s lékařem o zdravém přírůstku váhy.");
          else if (currentBMI > settings.bmiDangerUpper) recommendations.push("❤️ Vaše BMI je v pásmu obezity. Důrazně doporučujeme konzultaci s lékařem a úpravu životního stylu.");
          else if (currentBMI > settings.bmiWarningUpper) recommendations.push("💛 Vaše BMI signalizuje nadváhu. Doporučujeme zaměřit se na vyváženou stravu a pravidelný pohyb.");
          else recommendations.push("✅ Vaše BMI je v normálním rozmezí. Udržujte si zdravý životní styl!");
      } else if(settings.height) {
          recommendations.push("⚠️ Zadejte výšku pro výpočet BMI a relevantní doporučení.");
      }

      const sevenDaysAgo = new Date(new Date().setDate(new Date().getDate() - 7));
      const fourteenDaysAgo = new Date(new Date().setDate(new Date().getDate() - 14));
      
      const last7DaysEntries = weightLog.filter(e => new Date(e.date) >= sevenDaysAgo);
      const prev7DaysEntries = weightLog.filter(e => new Date(e.date) >= fourteenDaysAgo && new Date(e.date) < sevenDaysAgo);

      if (last7DaysEntries.length > 1 && prev7DaysEntries.length > 1) {
          const avgLast7 = last7DaysEntries.reduce((sum, e) => sum + e.weight, 0) / last7DaysEntries.length;
          const avgPrev7 = prev7DaysEntries.reduce((sum, e) => sum + e.weight, 0) / prev7DaysEntries.length;
          const weeklyTrend = avgLast7 - avgPrev7;

          if (Math.abs(weeklyTrend) > 1.5) { 
              recommendations.push(`⚠️ Rychlá změna váhy (${weeklyTrend.toFixed(1)} kg/týden průměrně). Zvažte pozvolnější tempo (ideálně 0.5-1 kg/týden).`);
          } else if (weeklyTrend !== 0) {
              recommendations.push(`📈 Týdenní trend váhy: ${weeklyTrend.toFixed(1)} kg. Pokračujte ve svém úsilí!`);
          }
      } else if (last7DaysEntries.length >=2) {
          const sortedWeek = last7DaysEntries.sort((a,b) => new Date(a.date) - new Date(b.date));
          const weekChange = sortedWeek[sortedWeek.length-1].weight - sortedWeek[0].weight;
           if (Math.abs(weekChange) > 1.5) {
             recommendations.push(`⚠️ Rychlá změna váhy za poslední dny: ${weekChange.toFixed(1)} kg. Doporučujeme pozvolnější změny.`);
           }
      }

      if (goals.targetWeight && goals.targetDate) {
        const daysToGoal = Math.ceil((new Date(goals.targetDate) - new Date()) / (1000 * 60 * 60 * 24));
        const weightToChange = goals.targetWeight - currentWeight;
        
        if (daysToGoal > 0 && weightToChange !== 0) {
          const requiredWeeklyChange = (weightToChange / (daysToGoal / 7)).toFixed(1);
          recommendations.push(`🎯 Pro dosažení cíle (${goals.targetWeight} kg) do ${formatDateForDisplay(goals.targetDate)}, je potřeba průměrná týdenní změna ${requiredWeeklyChange} kg.`);
           if (Math.abs(requiredWeeklyChange) > 1.5) {
               recommendations.push("💡 Tento týdenní cíl je poměrně ambiciózní. Ujistěte se, že je udržitelný a zdravý.");
           }
        } else if (weightToChange === 0) {
             recommendations.push(`🎯 Cílová váha ${goals.targetWeight} kg dosažena! Gratulujeme!`);
        } else if (daysToGoal <=0 && weightToChange !==0) {
            recommendations.push(`🗓️ Termín pro cíl ${goals.targetWeight} kg již vypršel. Zvažte nastavení nového cíle.`);
        }
      } else if (goals.targetWeight) {
           const weightToChange = goals.targetWeight - currentWeight;
           if (weightToChange === 0) recommendations.push(`🎯 Cílová váha ${goals.targetWeight} kg dosažena!`);
           else recommendations.push(`🎯 Cíl: ${goals.targetWeight} kg. Aktuálně zbývá ${weightToChange.toFixed(1)} kg.`);
      }

      const theoBMR = calculateBMR(currentWeight, settings.height, settings.age, settings.gender);
      const theoAMR = calculateAMR(theoBMR, settings.activityLevel);
      
      if (theoAMR > 0 && goals.weeklyGoal) {
          const weeklyCalDeficitOrSurplus = goals.weeklyGoal * 7700; 
          const dailyCalAdjustment = weeklyCalDeficitOrSurplus / 7;
          const targetCalories = Math.round(theoAMR + dailyCalAdjustment);
          let goalType = goals.weeklyGoal < 0 ? "hubnutí" : (goals.weeklyGoal > 0 ? "nabírání" : "udržování");

          recommendations.push(`🔥 Pro týdenní cíl ${goals.weeklyGoal} kg (${goalType}), váš odhadovaný denní příjem by mohl být okolo ${targetCalories} kcal (Teoretický AMR: ${Math.round(theoAMR)} kcal).`);
           if (targetCalories < theoBMR && goals.weeklyGoal < 0) { 
               recommendations.push("❗ Váš cílový denní příjem je pod vaším teoretickým BMR. Dlouhodobě to nemusí být udržitelné. Zvažte mírnější cíl nebo konzultaci s odborníkem.");
           }
      } else if (theoAMR > 0 && latestEntry.manualAMR) { 
           recommendations.push(`💡 Váš poslední zadaný AMR je ${latestEntry.manualAMR} kcal. Teoreticky vypočtený AMR je ${Math.round(theoAMR)} kcal. Rozdíl může být dán specifickou aktivitou nebo metodikou měření.`);
      }
      document.getElementById('recommendationText').innerHTML = recommendations.length > 0 ? recommendations.map(rec => `<p>${rec}</p>`).join('') : '<p>Žádná specifická doporučení. Udržujte zdravé návyky!</p>';
    }

    function updateDisplay() {
      updateTable();
      updateCharts();
      updateStats(); 
      updateRecommendations();
    }

    document.getElementById('entryForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const date = document.getElementById('entryDate').value;
      const weight = parseFloat(document.getElementById('entryWeight').value);
      const bodyFat = document.getElementById('entryBodyFat').value ? parseFloat(document.getElementById('entryBodyFat').value) : null;
      const muscleMass = document.getElementById('entryMuscleMass').value ? parseFloat(document.getElementById('entryMuscleMass').value) : null;
      const bodyWater = document.getElementById('entryBodyWater').value ? parseFloat(document.getElementById('entryBodyWater').value) : null;
      const manualBMR = document.getElementById('entryManualBMR').value ? parseInt(document.getElementById('entryManualBMR').value) : null;
      const manualAMR = document.getElementById('entryManualAMR').value ? parseInt(document.getElementById('entryManualAMR').value) : null;
      const notes = document.getElementById('entryNotes').value;

      if (isNaN(weight) || weight <= 0) {
          showNotification('Chyba: Zadejte platnou váhu.', 3000);
          return;
      }

      const newEntryData = { date, weight, bodyFat, muscleMass, bodyWater, manualBMR, manualAMR, notes };

      const existingIndex = weightLog.findIndex(entry => entry.date === date);
      if (existingIndex !== -1) {
        if (confirm('Záznam pro tento datum již existuje. Chcete ho přepsat?')) {
          weightLog[existingIndex] = newEntryData;
        } else return;
      } else {
        weightLog.push(newEntryData);
      }
      saveData();
      updateDisplay();
      showNotification('Záznam byl úspěšně přidán/aktualizován!');
      this.reset();
      setTodayDate(); 
      showTab('dashboard'); 
    });

    document.getElementById('settingsForm').addEventListener('submit', function(e) {
      e.preventDefault();
      settings.height = parseInt(document.getElementById('height').value);
      settings.age = document.getElementById('age').value ? parseInt(document.getElementById('age').value) : null;
      settings.gender = document.getElementById('gender').value;
      settings.activityLevel = parseFloat(document.getElementById('activityLevel').value);
      saveData();
      updateDisplay(); 
      showNotification('Nastavení byla uložena!');
    });

    document.getElementById('bmiAlertsForm').addEventListener('submit', function(e) {
      e.preventDefault();
      settings.bmiWarningUpper = parseFloat(document.getElementById('bmiWarningUpper').value);
      settings.bmiDangerUpper = parseFloat(document.getElementById('bmiDangerUpper').value);
      settings.bmiWarningLower = parseFloat(document.getElementById('bmiWarningLower').value);
      saveData();
      updateDisplay(); 
      showNotification('BMI hranice byly uloženy!');
    });

    document.getElementById('remindersForm').addEventListener('submit', function(e) {
      e.preventDefault();
      settings.reminderEnabled = document.getElementById('reminderEnabled').checked;
      settings.reminderInterval = parseInt(document.getElementById('reminderInterval').value);
      saveData();
      showNotification('Nastavení připomínek bylo uloženo!');
    });

    document.getElementById('goalsForm').addEventListener('submit', function(e) {
      e.preventDefault();
      goals.targetWeight = document.getElementById('targetWeight').value ? parseFloat(document.getElementById('targetWeight').value) : null;
      goals.targetBMI = document.getElementById('targetBMI').value ? parseFloat(document.getElementById('targetBMI').value) : null;
      goals.targetDate = document.getElementById('targetDate').value || null;
      goals.weeklyGoal = document.getElementById('weeklyGoal').value ? parseFloat(document.getElementById('weeklyGoal').value) : null;
      saveData();
      updateDisplay(); 
      showNotification('Cíle byly uloženy!');
    });

    function deleteEntry(date) {
      if (confirm(`Opravdu chcete smazat záznam ze dne ${formatDateForDisplay(date)}?`)) {
        weightLog = weightLog.filter(entry => entry.date !== date);
        saveData();
        updateDisplay();
        showNotification('Záznam byl smazán!');
      }
    }

    function editEntry(date) {
      const entry = weightLog.find(e => e.date === date);
      if (entry) {
        document.getElementById('entryDate').value = entry.date;
        document.getElementById('entryWeight').value = entry.weight;
        document.getElementById('entryBodyFat').value = entry.bodyFat || '';
        document.getElementById('entryMuscleMass').value = entry.muscleMass || '';
        document.getElementById('entryBodyWater').value = entry.bodyWater || '';
        document.getElementById('entryManualBMR').value = entry.manualBMR || '';
        document.getElementById('entryManualAMR').value = entry.manualAMR || '';
        document.getElementById('entryNotes').value = entry.notes || '';
        showTab('add-entry');
        showNotification(`Záznam ze dne ${formatDateForDisplay(date)} načten pro editaci.`);
      }
    }

    function exportToCSV() {
        if (weightLog.length === 0) {
            showNotification("Není co exportovat.", 2000);
            return;
        }
        const headers = ['Datum', 'Vaha (kg)', 'BMI', 'Telesny tuk (%)', 'Svalova hmota (%)', 'Svalova hmota (%)', 'Voda v tele (%)', 'Manual BMR', 'Manual AMR', 'Poznamky'];
        const rows = weightLog.map(entry => {
            let musclePercent = '';
            if (entry.muscleMass && entry.weight && entry.weight > 0) {
                musclePercent = ((entry.muscleMass / entry.weight) * 100).toFixed(1);
            }
            return [
                entry.date,
                entry.weight,
                calculateBMI(entry.weight, settings.height).toFixed(1),
                entry.bodyFat || '',
                musclePercent,
                entry.muscleMass || '',
                entry.bodyWater || '',
                entry.manualBMR || '',
                entry.manualAMR || '',
                `"${(entry.notes || '').replace(/"/g, '""')}"` 
            ];
        });

        const csvContent = "data:text/csv;charset=utf-8," + 
            headers.join(',') + '\n' + 
            rows.map(row => row.join(',')).join('\n');
        
        const encodedUri = encodeURI(csvContent);
        const link = document.createElement('a');
        link.setAttribute('href', encodedUri);
        link.setAttribute('download', `vaha_export_Jirik_${new Date().toISOString().split('T')[0]}.csv`);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification('CSV export dokončen!');
    }

    function exportToPDF() {
        if (weightLog.length === 0) {
            showNotification("Není co exportovat.", 2000);
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text('Váhový report - Admirál Jiřík', 14, 22);
        doc.setFontSize(11);
        doc.text(`Generováno: ${formatDateForDisplay(new Date().toISOString().split('T')[0])}`, 14, 30);
        doc.text(`Výška: ${settings.height} cm, Věk: ${settings.age || '-'} let, Pohlaví: ${settings.gender === 'male' ? 'Muž' : 'Žena'}`, 14, 36);
        
        const latestEntry = [...weightLog].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
        if (latestEntry) {
            const currentBMI = calculateBMI(latestEntry.weight, settings.height);
            const theoBMR = calculateBMR(latestEntry.weight, settings.height, settings.age, settings.gender);
            const theoAMR = calculateAMR(theoBMR, settings.activityLevel);
            doc.text(`Aktuální váha: ${latestEntry.weight.toFixed(1)} kg, BMI: ${currentBMI > 0 ? currentBMI.toFixed(1) : '-'}`, 14, 42);
            if (latestEntry.manualBMR || latestEntry.manualAMR) {
                 doc.text(`Posl. zadaný BMR: ${latestEntry.manualBMR || '-'} kcal, AMR: ${latestEntry.manualAMR || '-'} kcal`, 14, 48);
            } else {
                doc.text(`Teoretický BMR: ${theoBMR > 0 ? Math.round(theoBMR) : '-'} kcal, AMR: ${theoAMR > 0 ? Math.round(theoAMR) : '-'} kcal`, 14, 48);
            }
        }

        const tableColumn = ["#", "Datum", "Váha", "BMI", "Tuk%", "Svaly%", "Voda%", "Zad.BMR", "Zad.AMR"];
        const tableRows = [];
        const sortedLog = [...weightLog].sort((a, b) => new Date(a.date) - new Date(b.date)); 

        sortedLog.forEach((entry, index) => {
            const bmi = calculateBMI(entry.weight, settings.height);
            let musclePercentText = '-';
            if (entry.muscleMass && entry.weight && entry.weight > 0) {
                musclePercentText = ((entry.muscleMass / entry.weight) * 100).toFixed(1);
            }
            const rowData = [
                index + 1,
                formatDateForDisplay(entry.date),
                entry.weight.toFixed(1),
                bmi > 0 ? bmi.toFixed(1) : '-',
                entry.bodyFat !== null && entry.bodyFat !== undefined ? entry.bodyFat.toFixed(1) : '-',
                musclePercentText,
                entry.bodyWater !== null && entry.bodyWater !== undefined ? entry.bodyWater.toFixed(1) : '-',
                entry.manualBMR !== null && entry.manualBMR !== undefined ? entry.manualBMR : '-',
                entry.manualAMR !== null && entry.manualAMR !== undefined ? entry.manualAMR : '-',
            ];
            tableRows.push(rowData);
        });

        doc.autoTable({
            head: [tableColumn],
            body: tableRows,
            startY: 55,
            theme: 'grid',
            headStyles: { fillColor: [13, 17, 23], textColor: [0, 217, 255] },
            styles: { font: "Consolas", cellPadding: 1.5, fontSize: 7 }, 
            columnStyles: {
                0: { cellWidth: 8 }, 
                1: { cellWidth: 20 }, 
            }
        });
        
        doc.save(`vaha_report_Jirik_${new Date().toISOString().split('T')[0]}.pdf`);
        showNotification('PDF report dokončen!');
    }

    function exportChartsAsPDF() {
        if (weightLog.length === 0) {
            showNotification("Nejsou data pro export grafů.", 2000);
            return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4'); 
        let yPos = 20;
        const chartWidth = 180; 
        const chartHeight = 70; 
        const spacing = 10;    

        doc.setFontSize(18);
        doc.text('Grafy vývoje - Admirál Jiřík', doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });

        const chartsToExport = [
            { canvasId: 'weightChart', title: 'Vývoj váhy' },
            { canvasId: 'bmiChart', title: 'Vývoj BMI' },
            { canvasId: 'bodyFatOnlyChart', title: 'Vývoj tělesného tuku (%)' },
            { canvasId: 'muscleMassOnlyChart', title: 'Vývoj svalové hmoty (%)' },
            { canvasId: 'bodyWaterChart', title: 'Vývoj vody v těle (%)' },
            { canvasId: 'manualBMRChart', title: 'Vývoj zadaného BMR (kcal)' },
            { canvasId: 'manualAMRChart', title: 'Vývoj zadaného AMR (kcal)' }
        ];

        chartsToExport.forEach((chartInfo, index) => {
            const canvas = document.getElementById(chartInfo.canvasId);
            const chartInstance = Chart.getChart(canvas);
            let hasData = false;
            if (chartInstance && chartInstance.data.labels.length > 0) {
                hasData = chartInstance.data.datasets.some(dataset => dataset.data.some(d => d !== null && !isNaN(d) && d !== undefined));
            }

            if (!hasData) return; 

            if (yPos + chartHeight + spacing > doc.internal.pageSize.getHeight() - 15 && index > 0) { 
                doc.addPage();
                yPos = 20;
            }
            doc.setFontSize(12); 
            doc.text(chartInfo.title, 15, yPos);
            yPos += 5;
            const imgData = canvas.toDataURL('image/png', 0.95); 
            doc.addImage(imgData, 'PNG', 15, yPos, chartWidth, chartHeight);
            yPos += chartHeight + spacing;
        });
        
        doc.save(`vaha_grafy_Jirik_${new Date().toISOString().split('T')[0]}.pdf`);
        showNotification('Grafy exportovány do PDF!');
    }

    function exportBackup() {
        const backupData = {
            weightLog: weightLog,
            settings: settings,
            goals: goals,
            exportDate: new Date().toISOString(),
            appName: "Pokročilý váhový tracker více admirála Jiříka",
            version: "1.5.0"
        };
        const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `vaha_zaloha_Jirik_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showNotification('Úplná záloha vytvořena!');
    }

    function importFromCSV(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const csv = e.target.result;
            const lines = csv.split(/\r\n|\n/);
            if (lines.length <= 1) { /* ... */ }
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const muscleKgIdx = headers.indexOf('svalova hmota (%)');
            const musclePercentIdx = headers.indexOf('svalova hmota (%)'); 
            
            const dateIdx = headers.indexOf('datum');
            const weightIdx = headers.indexOf('vaha (kg)');
            const fatIdx = headers.indexOf('telesny tuk (%)');
            const waterIdx = headers.indexOf('voda v tele (%)');
            const manualBmrIdx = headers.indexOf('manual bmr');
            const manualAmrIdx = headers.indexOf('manual amr');
            const notesIdx = headers.indexOf('poznamky');


            let importedCount = 0;
            let skippedCount = 0;

            for (let i = 1; i < lines.length; i++) {
                const data = lines[i].split(',');

                const date = data[dateIdx] ? data[dateIdx].trim() : null;
                const weight = data[weightIdx] ? parseFloat(data[weightIdx].trim()) : null;

                if (!date || !weight || isNaN(weight)) { 
                    skippedCount++;
                    continue;
                }
                
                let muscleMassKg = null;
                if (muscleKgIdx !== -1 && data[muscleKgIdx] && !isNaN(parseFloat(data[muscleKgIdx].trim()))) {
                    muscleMassKg = parseFloat(data[muscleKgIdx].trim());
                } else if (musclePercentIdx !== -1 && data[musclePercentIdx] && !isNaN(parseFloat(data[musclePercentIdx].trim()))) {
                    const percent = parseFloat(data[musclePercentIdx].trim());
                    muscleMassKg = parseFloat(((percent / 100) * weight).toFixed(2)); // Ukládáme kg s přesností
                }

                const newEntry = {
                    date: date,
                    weight: weight,
                    bodyFat: fatIdx !== -1 && data[fatIdx] ? parseFloat(data[fatIdx].trim()) : null,
                    muscleMass: muscleMassKg,
                    bodyWater: waterIdx !== -1 && data[waterIdx] ? parseFloat(data[waterIdx].trim()) : null,
                    manualBMR: manualBmrIdx !== -1 && data[manualBmrIdx] ? parseInt(data[manualBmrIdx].trim()) : null,
                    manualAMR: manualAmrIdx !== -1 && data[manualAmrIdx] ? parseInt(data[manualAmrIdx].trim()) : null,
                    notes: notesIdx !== -1 && data[notesIdx] ? data[notesIdx].trim().replace(/^"|"$/g, '') : ""
                };
                const existingIndex = weightLog.findIndex(entry => entry.date === newEntry.date);
                if (existingIndex !== -1) {
                    weightLog[existingIndex] = newEntry;
                } else {
                    weightLog.push(newEntry);
                }
                importedCount++;
            }
            if (importedCount > 0) {
                saveData();
                updateDisplay();
                showNotification(`Importováno ${importedCount} záznamů. ${skippedCount > 0 ? skippedCount + ' přeskočeno.' : ''}`);
            } else {
                showNotification('Nebyly nalezeny žádné platné záznamy k importu v CSV.', 3000);
            }
            inputElement.value = ''; 
        };
        reader.readAsText(file);
    }

    function importFromBackup(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const backupData = JSON.parse(e.target.result);
                if (backupData.appName !== "Pokročilý váhový tracker více admirála Jiříka") {
                   if(!confirm("Zdá se, že tento soubor nepochází z této aplikace. Přesto pokračovat?")) {
                       inputElement.value = ''; return;
                   }
                }

                if (backupData.weightLog) weightLog = backupData.weightLog;
                if (backupData.settings) settings = { ...settings, ...backupData.settings }; 
                if (backupData.goals) goals = { ...goals, ...backupData.goals };
                
                weightLog.forEach(entry => {
                    if (entry.manualBMR === undefined) entry.manualBMR = null;
                    if (entry.manualAMR === undefined) entry.manualAMR = null;
                    if (entry.muscleMass === undefined) entry.muscleMass = null; 
                });

                saveData();
                updateForms(); 
                updateDisplay();
                showNotification('Záloha úspěšně obnovena!');
            } catch (error) {
                showNotification('Chyba při načítání zálohy: ' + error.message, 4000);
                console.error("Backup import error:", error);
            }
            inputElement.value = ''; 
        };
        reader.readAsText(file);
    }

    function clearAllData() {
      if (confirm('⚠️ OPRAVDU chcete smazat VŠECHNA data? Tuto akci nelze vrátit zpět!')) {
        if (confirm('⚠️ JSTE SI ABSOLUTNĚ JISTI? Všechna data budou nenávratně ztracena!')) {
          localStorage.removeItem('weightLog_JirikTracker_v2_charts_separated_musclePercent'); 
          localStorage.removeItem('weightSettings_JirikTracker_v2_charts_separated_musclePercent');
          localStorage.removeItem('weightGoals_JirikTracker_v2_charts_separated_musclePercent');
          weightLog = [];
          // Reset settings a goals na výchozí hodnoty
          settings = { height: 174, age: null, gender: 'male', activityLevel: 1.55, bmiWarningUpper: 25, bmiDangerUpper: 30, bmiWarningLower: 18.5, reminderEnabled: true, reminderInterval: 7 };
          goals = { targetWeight: null, targetBMI: null, targetDate: null, weeklyGoal: null };
          loadData(); // Znovu načte (prázdná nebo výchozí data) a aktualizuje UI
          showNotification('Všechna data byla smazána!');
        }
      }
    }

    function checkReminders() {
      if (!settings.reminderEnabled || weightLog.length === 0) return;
      const lastEntry = [...weightLog].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
      if (lastEntry) {
        const daysSinceLastEntry = Math.floor((new Date() - new Date(lastEntry.date)) / (1000 * 60 * 60 * 24));
        if (daysSinceLastEntry >= settings.reminderInterval) {
          showNotification(`⏰ Připomínka: Poslední záznam váhy byl před ${daysSinceLastEntry} dny (${formatDateForDisplay(lastEntry.date)})!`, 5000);
        }
      }
    }
    setInterval(checkReminders, 30 * 60 * 1000); 

    function toggleFullScreen() {
      const elem = document.documentElement;
      const btn = document.getElementById('fullscreen-btn');
      if (!document.fullscreenElement) {
        if (elem.requestFullscreen) elem.requestFullscreen().catch(err => console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`));
        else if (elem.mozRequestFullScreen) elem.mozRequestFullScreen();
        else if (elem.webkitRequestFullscreen) elem.webkitRequestFullscreen();
        else if (elem.msRequestFullscreen) elem.msRequestFullscreen();
        if(btn) btn.innerHTML = '&#10006;'; 
      } else {
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.mozCancelFullScreen) document.mozCancelFullScreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        else if (document.msExitFullscreen) document.msExitFullscreen();
        if(btn) btn.innerHTML = '&#x26F6;'; 
      }
    }
    
    function updateFullscreenButtonIcon() {
        const btn = document.getElementById('fullscreen-btn');
        if(!btn) return;
        if (document.fullscreenElement || document.mozFullScreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
            btn.innerHTML = '&#10006;'; 
        } else {
            btn.innerHTML = '&#x26F6;'; 
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const fullscreenButton = document.createElement('button');
        fullscreenButton.className = 'fullscreen';
        fullscreenButton.id = 'fullscreen-btn';
        fullscreenButton.innerHTML = '&#x26F6;';
        fullscreenButton.title = 'Přepnout na celou obrazovku';
        fullscreenButton.addEventListener('click', toggleFullScreen);
        document.body.appendChild(fullscreenButton);

        ['fullscreenchange', 'mozfullscreenchange', 'webkitfullscreenchange', 'msfullscreenchange'].forEach(event => 
            document.addEventListener(event, updateFullscreenButtonIcon)
        );
    });

  </script>
</body>
</html>